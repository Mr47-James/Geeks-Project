{% extends "base.html" %}

{% block title %}{{ track.title }} - {{ track.artist.name }} | Harmony{% endblock %}

{% block content %}
<div class="track-detail-page">
    <!-- Hero Section -->
    <section class="glass-card track-hero mb-5">
        <div class="row align-items-center">
            <!-- Track Information -->
            <div class="col-lg-8">
                <div class="track-info">
                    <h1 class="track-title display-4 mb-3">{{ track.title }}</h1>
                    <p class="track-artist h4 mb-4 text-muted">by {{ track.artist.name }}</p>

                    <!-- Track Metadata -->
                    <div class="track-meta mb-4">
                        <div class="row g-3">
                            {% if track.album %}
                            <div class="col-auto">
                                <span class="badge bg-secondary-subtle text-secondary px-3 py-2">
                                    <i class="fas fa-compact-disc me-1"></i>{{ track.album }}
                                </span>
                            </div>
                            {% endif %}
                            {% if track.genre %}
                            <div class="col-auto">
                                <span class="badge bg-info-subtle text-info px-3 py-2">
                                    <i class="fas fa-tag me-1"></i>{{ track.genre }}
                                </span>
                            </div>
                            {% endif %}
                            {% if track.release_year %}
                            <div class="col-auto">
                                <span class="badge bg-success-subtle text-success px-3 py-2">
                                    <i class="fas fa-calendar me-1"></i>{{ track.release_year }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="track-actions mb-4">
                        <button class="btn btn-primary btn-lg me-3 play-track-btn" data-track-id="{{ track.id }}">
                            <i class="fas fa-play me-2"></i>Play Track
                        </button>
                        <button onclick="toggleBookmark({{ track.id }})" class="btn btn-secondary btn-lg me-3" id="bookmark-btn">
                            <i class="fas fa-bookmark me-2"></i>
                            {% if is_bookmarked %}Remove Bookmark{% else %}Bookmark{% endif %}
                        </button>
                        <button onclick="addToQueue({{ track.id }})" class="btn btn-glass btn-lg me-3">
                            <i class="fas fa-plus me-2"></i>Add to Queue
                        </button>
                        <a href="{{ url_for('client_tracks') }}" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>Back to Browse
                        </a>
                    </div>

                    <!-- Preference Buttons -->
                    <div class="preference-buttons">
                        <button onclick="likeTrack({{ track.id }})"
                                class="btn btn-success me-2 {% if user_preference and user_preference.preference == 'like' %}active{% endif %}"
                                id="like-btn">
                            <i class="fas fa-thumbs-up me-1"></i>Like
                        </button>
                        <button onclick="dislikeTrack({{ track.id }})"
                                class="btn btn-danger {% if user_preference and user_preference.preference == 'dislike' %}active{% endif %}"
                                id="dislike-btn">
                            <i class="fas fa-thumbs-down me-1"></i>Dislike
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Sidebar -->
            <div class="col-lg-4">
                <div class="track-stats text-center">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value display-6 text-primary fw-bold" id="play-count">{{ track.play_count }}</div>
                            <div class="stat-label text-muted">Plays</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value display-6 text-success fw-bold" id="like-count">{{ track.like_count }}</div>
                            <div class="stat-label text-muted">Likes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value display-6 text-warning fw-bold" id="dislike-count">{{ track.dislike_count }}</div>
                            <div class="stat-label text-muted">Dislikes</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content Grid -->
    <div class="row g-5">
        <!-- Track Details -->
        <div class="col-lg-8">
            <section class="glass-card track-details">
                <div class="card-header border-bottom">
                    <h2 class="h4 mb-0">
                        <i class="fas fa-info-circle me-2"></i>Track Information
                    </h2>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                <span class="info-label fw-semibold text-muted">Duration</span>
                                <span class="info-value">{{ track.format_duration() }}</span>
                            </div>
                        </div>
                        {% if track.bitrate %}
                        <div class="col-md-6">
                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                <span class="info-label fw-semibold text-muted">Bitrate</span>
                                <span class="info-value">{{ track.bitrate }} kbps</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if track.sample_rate %}
                        <div class="col-md-6">
                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                <span class="info-label fw-semibold text-muted">Sample Rate</span>
                                <span class="info-value">{{ track.sample_rate }} Hz</span>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                <span class="info-label fw-semibold text-muted">File Size</span>
                                <span class="info-value">{{ track.file_size|filesizeformat if track.file_size else 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                <span class="info-label fw-semibold text-muted">Upload Date</span>
                                <span class="info-value">{{ track.upload_date.strftime('%B %d, %Y') if track.upload_date else 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Artist Information -->
        <div class="col-lg-4">
            <section class="glass-card artist-info">
                <div class="card-header border-bottom">
                    <h2 class="h4 mb-0">
                        <i class="fas fa-microphone me-2"></i>About the Artist
                    </h2>
                </div>
                <div class="card-body text-center">
                    <div class="artist-avatar mx-auto mb-3">
                        <span class="avatar-text">{{ track.artist.name[:1]|upper }}</span>
                    </div>
                    <h3 class="h5 mb-2">{{ track.artist.name }}</h3>
                    {% if track.artist.country %}
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ track.artist.country }}
                    </p>
                    {% endif %}
                    {% if track.artist.bio %}
                    <p class="artist-bio text-muted small">{{ track.artist.bio[:150] }}{% if track.artist.bio|length > 150 %}â€¦{% endif %}</p>
                    {% endif %}
                    <div class="mt-3">
                        <a href="{{ url_for('artist_details', artist_id=track.artist.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-user me-1"></i>View Artist
                        </a>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Similar Tracks -->
    {% if similar_tracks %}
    <section class="glass-card similar-tracks mt-5">
        <div class="card-header border-bottom">
            <h2 class="h4 mb-0">
                <i class="fas fa-music me-2"></i>Similar Tracks
            </h2>
        </div>
        <div class="card-body">
            <div class="row g-4">
                {% for similar_track in similar_tracks %}
                <div class="col-lg-4 col-md-6">
                    <div class="similar-track-card glass-card h-100">
                        <div class="card-body d-flex flex-column">
                            <h4 class="card-title h6 mb-2">{{ similar_track.title }}</h4>
                            <p class="card-text text-muted small mb-3">{{ similar_track.artist.name }}</p>
                            <div class="mt-auto">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button class="btn btn-primary btn-sm w-100 play-track-btn" data-track-id="{{ similar_track.id }}">
                                            <i class="fas fa-play me-1"></i>Play
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <a href="{{ url_for('client_track_detail', track_id=similar_track.id) }}" class="btn btn-outline-secondary btn-sm w-100">
                                            <i class="fas fa-info me-1"></i>Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
</div>

<style>
/* ===== PAGE LAYOUT ===== */
.track-detail-page {
    padding: 2rem 0;
}

/* ===== HERO SECTION ===== */
.track-hero {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.track-title {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
}

/* ===== METADATA & BADGES ===== */
.track-meta .badge {
    font-size: 0.85rem;
    font-weight: 500;
}

/* ===== ACTION BUTTONS ===== */
.track-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.preference-buttons .btn.active {
    opacity: 0.7;
    transform: scale(0.95);
}

/* ===== STATISTICS ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    margin-top: 2rem;
}

.stat-item {
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    transition: transform 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-5px);
}

.stat-value {
    margin-bottom: 0.5rem;
}

/* ===== TRACK DETAILS ===== */
.track-details .info-item {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.track-details .info-item:last-child {
    border-bottom: none;
}

/* ===== ARTIST INFO ===== */
.artist-avatar {
    width: 80px;
    height: 80px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    margin: 0 auto;
}

/* ===== SIMILAR TRACKS ===== */
.similar-track-card {
    transition: all 0.3s ease;
}

.similar-track-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
    .track-hero .row {
        text-align: center;
    }

    .track-actions {
        justify-content: center;
    }

    .stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .track-details .row > div {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 1rem;
        padding-bottom: 1rem;
    }

    .track-details .row > div:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ===== INITIALIZATION =====
let isBookmarked = {{ 'true' if is_bookmarked else 'false' }};

// ===== TRACK PLAYBACK =====
async function playTrack(trackId) {
    try {
        const response = await fetch(`/client/track/${trackId}/play`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ duration: 30 })
        });

        const data = await response.json();

        if (data.status === 'success') {
            document.getElementById('play-count').textContent = data.play_count;
            // TODO: Integrate with actual audio player
            alert('Playing track... (Audio player integration needed)');
        } else {
            alert('Error playing track: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while playing the track');
    }
}

// ===== BOOKMARK MANAGEMENT =====
async function toggleBookmark(trackId) {
    try {
        const response = await fetch(`/client/track/${trackId}/bookmark`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            isBookmarked = data.bookmarked;
            const btn = document.getElementById('bookmark-btn');
            btn.innerHTML = isBookmarked ?
                '<i class="fas fa-bookmark me-2"></i>Remove Bookmark' :
                '<i class="fas fa-bookmark me-2"></i>Bookmark';
        } else {
            alert('Error toggling bookmark: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while toggling bookmark');
    }
}

// ===== PREFERENCE MANAGEMENT =====
async function likeTrack(trackId) {
    try {
        const response = await fetch(`/client/track/${trackId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            updatePreferenceCounts(data.likes, data.dislikes);
            setActivePreference('like');
        } else {
            alert('Error liking track: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while liking the track');
    }
}

async function dislikeTrack(trackId) {
    try {
        const response = await fetch(`/client/track/${trackId}/dislike`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.status === 'success') {
            updatePreferenceCounts(data.likes, data.dislikes);
            setActivePreference('dislike');
        } else {
            alert('Error disliking track: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while disliking the track');
    }
}

// ===== QUEUE MANAGEMENT =====
async function addToQueue(trackId) {
    try {
        // Get track info first
        const response = await fetch(`/api/track/${trackId}/info`);
        const trackInfo = await response.json();

        // Add to player queue
        if (window.harmonyPlayer) {
            window.harmonyPlayer.addToQueue(trackInfo);
        } else {
            alert('Audio player not ready. Please try again.');
        }
    } catch (error) {
        console.error('Error adding to queue:', error);
        alert('An error occurred while adding track to queue');
    }
}

// ===== UTILITY FUNCTIONS =====
function updatePreferenceCounts(likes, dislikes) {
    document.getElementById('like-count').textContent = likes;
    document.getElementById('dislike-count').textContent = dislikes;
}

function setActivePreference(preference) {
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');

    // Remove active class from both buttons
    likeBtn.classList.remove('active');
    dislikeBtn.classList.remove('active');

    // Add active class to the selected preference
    if (preference === 'like') {
        likeBtn.classList.add('active');
    } else if (preference === 'dislike') {
        dislikeBtn.classList.add('active');
    }
}

// ===== EVENT INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    // Initialize play buttons
    document.querySelectorAll('.play-track-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const trackId = this.getAttribute('data-track-id');
            playTrack(trackId);
        });
    });
});
</script>
{% endblock %}
