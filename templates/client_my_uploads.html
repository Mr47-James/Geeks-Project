{% extends "base.html" %}

{% block title %}My Uploads | Harmony{% endblock %}

{% block content %}
<style>
    .uploads-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 3rem;
        animation: fadeInUp 0.8s ease;
    }

    .uploads-title {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .upload-button {
        padding: 1rem 2rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .upload-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        color: white;
    }

    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
        animation: fadeInUp 0.8s ease 0.2s both;
    }

    .stat-card {
        padding: 2rem;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient, var(--primary));
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .stat-card:hover {
        transform: translateY(-5px) scale(1.02);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        background: var(--gradient, var(--primary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 1.5rem;
        animation: pulse 2s infinite;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        display: block;
    }

    .stat-label {
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.85rem;
    }

    .tracks-section {
        margin-bottom: 3rem;
        animation: fadeInUp 0.8s ease 0.4s both;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: #667eea;
    }

    .tracks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .track-card {
        padding: 1.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.8s ease var(--delay, 0.6s) both;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .track-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--gradient, var(--primary));
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .track-card:hover::before {
        transform: scaleY(1);
    }

    .track-card:hover {
        transform: translateY(-5px) scale(1.02);
    }

    .track-artwork {
        width: 80px;
        height: 80px;
        background: var(--gradient, var(--secondary));
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        margin-bottom: 1rem;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .track-artwork .play-track-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 2;
    }

    .track-card:hover .track-artwork .play-track-btn {
        opacity: 1;
    }

    .track-artwork::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .track-card:hover .track-artwork::before {
        transform: translateX(100%);
    }

    .track-card:hover .track-artwork {
        transform: scale(1.1) rotate(5deg);
    }

    .track-info {
        margin-bottom: 1rem;
    }

    .track-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .track-artist {
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .track-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--text-muted);
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .track-meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .track-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 1rem;
    }

    .track-action {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: var(--glass-bg);
        backdrop-filter: var(--glass-backdrop);
        -webkit-backdrop-filter: var(--glass-backdrop);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .track-action:hover {
        transform: scale(1.1);
        background: var(--primary);
        color: white;
    }

    .track-action.active {
        background: var(--success);
        color: white;
    }

    .track-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--glass-border);
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .track-stat {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .upload-date {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        animation: fadeInUp 0.8s ease 0.6s both;
    }

    .empty-icon {
        width: 100px;
        height: 100px;
        background: var(--glass-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 2rem;
        font-size: 2.5rem;
        color: var(--text-muted);
    }

    .empty-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }

    .empty-message {
        color: var(--text-secondary);
        margin-bottom: 2rem;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .uploads-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .tracks-grid {
            grid-template-columns: 1fr;
        }

        .stats-section {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .stats-section {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Uploads Header -->
<div class="uploads-header">
    <h1 class="uploads-title">My Uploads</h1>
    <a href="{{ url_for('client_upload_tracks') }}" class="upload-button">
        <i class="fas fa-plus"></i>
        Upload New Track
    </a>
</div>

<!-- Stats Section -->
<div class="stats-section">
    <div class="glass-card stat-card" style="--gradient: var(--primary);">
        <div class="stat-icon">
            <i class="fas fa-music"></i>
        </div>
        <span class="stat-number">{{ user_tracks|length }}</span>
        <span class="stat-label">Total Tracks</span>
    </div>
    
    <div class="glass-card stat-card" style="--gradient: var(--secondary);">
        <div class="stat-icon">
            <i class="fas fa-play"></i>
        </div>
        <span class="stat-number">{{ user_tracks|sum(attribute='play_count') or 0 }}</span>
        <span class="stat-label">Total Plays</span>
    </div>
    
    <div class="glass-card stat-card" style="--gradient: var(--accent);">
        <div class="stat-icon">
            <i class="fas fa-heart"></i>
        </div>
        <span class="stat-number">{{ user_tracks|sum(attribute='like_count') or 0 }}</span>
        <span class="stat-label">Total Likes</span>
    </div>
    
    <div class="glass-card stat-card" style="--gradient: var(--success);">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <span class="stat-number">{{ ((user_tracks|sum(attribute='duration') or 0) / 60)|round|int }}m</span>
        <span class="stat-label">Total Duration</span>
    </div>
</div>

<!-- Tracks Section -->
<div class="tracks-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-music"></i>
            Your Uploaded Tracks
        </h2>
    </div>
    
    {% if user_tracks %}
    <div class="tracks-grid">
        {% for track in user_tracks %}
        <div class="glass-card track-card" style="--delay: {{ 0.6 + loop.index * 0.05 }}s; --gradient: var(--{{ ['primary', 'secondary', 'accent', 'success'][loop.index % 4] }});">
            <div class="track-artwork">
                <i class="fas fa-music"></i>
                <button class="play-track-btn" data-track-id="{{ track.id }}" title="Play {{ track.title }}">
                    <i class="fas fa-play"></i>
                </button>
            </div>
            <div class="track-info">
                <div class="track-title">{{ track.title }}</div>
                <div class="track-artist">{{ track.artist.name if track.artist else 'Unknown Artist' }}</div>
                <div class="track-meta">
                    {% if track.album %}
                    <div class="track-meta-item">
                        <i class="fas fa-compact-disc"></i>
                        <span>{{ track.album }}</span>
                    </div>
                    {% endif %}
                    {% if track.genre %}
                    <div class="track-meta-item">
                        <i class="fas fa-tag"></i>
                        <span>{{ track.genre }}</span>
                    </div>
                    {% endif %}
                    {% if track.duration %}
                    <div class="track-meta-item">
                        <i class="fas fa-clock"></i>
                        <span>{{ track.format_duration() if track.format_duration else (track.duration // 60)|string + ':' + (track.duration % 60)|string.zfill(2) }}</span>
                    </div>
                    {% endif %}
                    {% if track.file_size %}
                    <div class="track-meta-item">
                        <i class="fas fa-file"></i>
                        <span>{{ (track.file_size / 1024 / 1024)|round(1) }}MB</span>
                    </div>
                    {% endif %}
                </div>
                <div class="upload-date">
                    <i class="fas fa-calendar"></i>
                    <span>Uploaded {{ track.created_at.strftime('%b %d, %Y') if track.created_at else 'Unknown' }}</span>
                </div>
            </div>
            <div class="track-actions">
                <button class="track-action" onclick="event.stopPropagation(); editTrack({{ track.id }})" title="Edit track">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="track-action" onclick="event.stopPropagation(); addToPlaylist({{ track.id }})" title="Add to playlist">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="track-action" onclick="event.stopPropagation(); shareTrack({{ track.id }})" title="Share track">
                    <i class="fas fa-share"></i>
                </button>
                <button class="track-action" onclick="event.stopPropagation(); deleteTrack({{ track.id }})" title="Delete track">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="track-stats">
                <div class="track-stat">
                    <i class="fas fa-play"></i>
                    <span>{{ track.play_count }} plays</span>
                </div>
                <div class="track-stat">
                    <i class="fas fa-heart"></i>
                    <span>{{ track.like_count }} likes</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-music"></i>
        </div>
        <h3 class="empty-title">No uploads yet</h3>
        <p class="empty-message">
            You haven't uploaded any tracks yet. Share your music with the Harmony community by uploading your original tracks.
        </p>
        <a href="{{ url_for('client_upload_tracks') }}" class="btn btn-primary">
            <i class="fas fa-upload"></i>
            Upload Your First Track
        </a>
    </div>
    {% endif %}
</div>

<script>
    // Play track function
    function playTrack(trackId) {
        const flashContainer = document.querySelector('.flash-messages');
        const notification = document.createElement('div');
        notification.className = 'flash-message info';
        notification.innerHTML = '<i class="fas fa-play"></i> Playing track... (Audio player integration coming soon!)';
        flashContainer.appendChild(notification);
        
        // Track play activity
        fetch(`/client/track/${trackId}/play`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ duration: 0 })
        }).catch(console.error);
        
        setTimeout(() => notification.remove(), 3000);
    }

    // Edit track function
    function editTrack(trackId) {
        window.location.href = `/tracks/${trackId}/edit`;
    }

    // Add to playlist function
    function addToPlaylist(trackId) {
        // First, get user's playlists
        fetch('/api/playlists')
        .then(response => response.json())
        .then(playlists => {
            if (playlists.length === 0) {
                const createNew = confirm('You don\'t have any playlists yet. Would you like to create one?');
                if (createNew) {
                    createPlaylistAndAdd(trackId);
                }
                return;
            }
            
            // Show playlist selection
            let playlistOptions = playlists.map(p => `${p.id}: ${p.name} (${p.track_count} tracks)`).join('\n');
            let selectedPlaylist = prompt(`Select a playlist by entering its number:\n\n${playlistOptions}\n\nOr enter 'new' to create a new playlist:`);
            
            if (!selectedPlaylist) return;
            
            if (selectedPlaylist.toLowerCase() === 'new') {
                createPlaylistAndAdd(trackId);
                return;
            }
            
            const playlistId = parseInt(selectedPlaylist);
            const playlist = playlists.find(p => p.id === playlistId);
            
            if (!playlist) {
                alert('Invalid playlist selection.');
                return;
            }
            
            // Add track to selected playlist
            fetch(`/client/playlists/${playlistId}/add-track`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ track_id: trackId })
            })
            .then(response => response.json())
            .then(data => {
                const flashContainer = document.querySelector('.flash-messages');
                const notification = document.createElement('div');
                notification.className = data.status === 'success' ? 'flash-message success' : 'flash-message error';
                notification.innerHTML = `<i class="fas fa-${data.status === 'success' ? 'check' : 'exclamation-triangle'}"></i> ${data.message}`;
                flashContainer.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                const flashContainer = document.querySelector('.flash-messages');
                const notification = document.createElement('div');
                notification.className = 'flash-message error';
                notification.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error adding track to playlist';
                flashContainer.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            const flashContainer = document.querySelector('.flash-messages');
            const notification = document.createElement('div');
            notification.className = 'flash-message error';
            notification.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading playlists';
            flashContainer.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        });
    }

    // Create playlist and add track
    function createPlaylistAndAdd(trackId) {
        const name = prompt('Enter playlist name:');
        if (!name || !name.trim()) {
            return;
        }
        
        const description = prompt('Enter playlist description (optional):') || '';
        const isPublic = confirm('Make this playlist public?');
        
        fetch('/client/playlists/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name.trim(),
                description: description.trim(),
                is_public: isPublic
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Add track to the newly created playlist
                fetch(`/client/playlists/${data.playlist.id}/add-track`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ track_id: trackId })
                })
                .then(response => response.json())
                .then(addData => {
                    const flashContainer = document.querySelector('.flash-messages');
                    const notification = document.createElement('div');
                    notification.className = addData.status === 'success' ? 'flash-message success' : 'flash-message error';
                    notification.innerHTML = `<i class="fas fa-${addData.status === 'success' ? 'check' : 'exclamation-triangle'}"></i> ${addData.message}`;
                    flashContainer.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                });
            } else {
                const flashContainer = document.querySelector('.flash-messages');
                const notification = document.createElement('div');
                notification.className = 'flash-message error';
                notification.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.message}`;
                flashContainer.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const flashContainer = document.querySelector('.flash-messages');
            const notification = document.createElement('div');
            notification.className = 'flash-message error';
            notification.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error creating playlist';
            flashContainer.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        });
    }

    // Share track function
    function shareTrack(trackId) {
        const flashContainer = document.querySelector('.flash-messages');
        const notification = document.createElement('div');
        notification.className = 'flash-message info';
        notification.innerHTML = '<i class="fas fa-share"></i> Share functionality coming soon!';
        flashContainer.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Delete track function
    function deleteTrack(trackId) {
        if (!confirm('Are you sure you want to delete this track? This action cannot be undone.')) {
            return;
        }
        
        fetch(`/tracks/${trackId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                const flashContainer = document.querySelector('.flash-messages');
                const notification = document.createElement('div');
                notification.className = 'flash-message success';
                notification.innerHTML = '<i class="fas fa-check"></i> Track deleted successfully';
                flashContainer.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
                
                // Refresh page after a short delay
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error('Failed to delete track');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const flashContainer = document.querySelector('.flash-messages');
            const notification = document.createElement('div');
            notification.className = 'flash-message error';
            notification.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error deleting track';
            flashContainer.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        });
    }

    // Add hover effects to track cards
    document.querySelectorAll('.track-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            const artwork = this.querySelector('.track-artwork');
            if (artwork) {
                artwork.style.transform = 'scale(1.1) rotate(5deg)';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            const artwork = this.querySelector('.track-artwork');
            if (artwork) {
                artwork.style.transform = 'scale(1) rotate(0deg)';
            }
        });
    });
</script>
{% endblock %}